Sub Raport()

Dim a1, a2 As Worksheet
    Set a1 = Worksheets("Arkusz1")
    Set a2 = Worksheets("Arkusz2")
Dim data As Date
Dim np1 As Range
Dim xp1 As Range
With Application
.ScreenUpdating = False
End With

a1.Activate
Dim np As Double
np = WorksheetFunction.CountA(Range("M:M")) - 4
    Set np1 = a1.Cells(np, 1)
Dim xp As Double
xp = WorksheetFunction.CountA(Range("M:M")) - 2
    Set xp1 = a1.Cells(xp, 14)
a1.Range(np1, xp1).Copy
a2.Activate
Cells(3, 1).Select
Selection.PasteSpecial Paste:=xlPasteValues, Transpose:=False
data = a2.Cells(5, 1).Value
a1.Activate
a1.Range(np1, xp1).Copy
Cells(np, 1).Select
Selection.PasteSpecial Paste:=xlPasteValues, Transpose:=False
Application.CutCopyMode = False

Dim rng As Range
    Set rng = Range(a2.Cells(1, 1), a2.Cells(5, 14)).SpecialCells(xlCellTypeVisible)
    Set poczta = CreateObject("outlook.application")
  Set mail = poczta.CreateItem(0)
  
On Error Resume Next
      With mail
        .To = Sheets("lista_mail").Cells(3, 2)
        .CC = Sheets("lista_mail").Cells(4, 2)
        .Subject = "Report - " & Format(data, "dd.mm.yyyy")
        .htmlBody = RangetoHTML(rng) & ""
        .display
      End With
      On Error GoTo 0
      Set mail = Nothing
      Set poczta = Nothing
      
End Sub

Function RangetoHTML(rng As Range)

    Dim fso As Object
    Dim ts As Object
    Dim TempFile As String
    Dim TempWB As Workbook

    TempFile = Environ$("temp") & "\" & Format(Now, "dd-mm-yy h-mm-ss") & ".htm"

    rng.Copy
    Set TempWB = Workbooks.Add(1)
    With TempWB.Sheets(1)
        .Cells(1).PasteSpecial Paste:=8
        .Cells(1).PasteSpecial xlPasteAllUsingSourceTheme, , False, False
        .Cells(1).PasteSpecial xlPasteValues, , False, False
        .Cells(1).Select
        Application.CutCopyMode = False
        On Error Resume Next
        .DrawingObjects.Visible = True
        .DrawingObjects.Delete
        On Error GoTo 0
    End With

    With TempWB.PublishObjects.Add( _
         SourceType:=xlSourceRange, _
         Filename:=TempFile, _
         Sheet:=TempWB.Sheets(1).Name, _
         Source:=TempWB.Sheets(1).UsedRange.Address, _
         HtmlType:=xlHtmlStatic)
        .Publish (True)
    End With

    Set fso = CreateObject("Scripting.FileSystemObject")
    Set ts = fso.GetFile(TempFile).OpenAsTextStream(1, -2)
    RangetoHTML = ts.readall
    ts.Close
    RangetoHTML = Replace(RangetoHTML, "align=center x:publishsource=", "align=left x:publishsource=")

    TempWB.Close savechanges:=False

    Kill TempFile

    Set ts = Nothing
    Set fso = Nothing
    Set TempWB = Nothing
End Function
